<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Branching Scenario Configurator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .panel {
            background: white;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 24px;
        }

        h2 {
            color: #34495e;
            margin: 25px 0 15px 0;
            font-size: 18px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }

        h3 {
            color: #34495e;
            margin: 15px 0 10px 0;
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            color: #555;
            font-weight: 600;
            font-size: 14px;
        }

        input[type="text"],
        input[type="color"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        input[type="color"] {
            height: 45px;
            cursor: pointer;
        }

        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group label {
            margin: 0;
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            margin-right: 10px;
            margin-top: 10px;
        }

        .btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #95a5a6;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #229954;
        }

        .scenario-card {
            background: #f8f9fa;
            border: 2px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .choice-card {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .code-output {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
            position: relative;
        }

        .copy-btn {
            position: sticky;
            top: 10px;
            float: right;
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            z-index: 10;
        }

        .copy-btn:hover {
            background: #2980b9;
        }

        .hint {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 4px;
        }

        .color-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .scenario-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .feedback-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 10px;
        }

        .feedback-options label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: normal;
        }

        .threshold-info {
            background: #e8f4f8;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #2c3e50;
            font-weight: 600;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 12px 24px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #7f8c8d;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }

        .tab-btn:hover {
            color: #2980b9;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        iframe {
            width: 100%;
            height: 600px;
            border: 2px solid #ddd;
            border-radius: 6px;
            background: white;
        }

        @media (max-width: 768px) {
            .color-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Step 1: Scenarios -->
        <div class="panel">
            <h1>📚 Step 1: Create Your Scenarios</h1>
            <button class="btn btn-success" onclick="addScenario()">+ Add New Scenario</button>
            
            <div class="scenario-list" id="scenarioList"></div>
        </div>

        <!-- Step 2: Performance Thresholds -->
        <div class="panel">
            <h1>🎯 Step 2: Set Performance Thresholds</h1>
            <div class="threshold-info" id="thresholdInfo">
                You currently have <strong>0 scenarios</strong>. Add scenarios above to configure thresholds.
            </div>
            
            <div id="thresholdInputs" style="display: none;">
                <div class="form-group">
                    <label>Excellent (number of correct scenarios out of <span id="total1">0</span>)</label>
                    <input type="number" id="excellentThreshold" value="0" min="0">
                </div>
                <div class="form-group">
                    <label>Good (number of correct scenarios out of <span id="total2">0</span>)</label>
                    <input type="number" id="goodThreshold" value="0" min="0">
                </div>
                <div class="form-group">
                    <label>Developing (number of correct scenarios out of <span id="total3">0</span>)</label>
                    <input type="number" id="developingThreshold" value="0" min="0">
                </div>

                <h2>Performance Messages</h2>
                <div class="form-group">
                    <label>Excellent Performance Message</label>
                    <textarea id="excellentMsg" placeholder="Message shown when learner achieves Excellent performance"></textarea>
                </div>
                <div class="form-group">
                    <label>Good Performance Message</label>
                    <textarea id="goodMsg" placeholder="Message shown when learner achieves Good performance"></textarea>
                </div>
                <div class="form-group">
                    <label>Developing Performance Message</label>
                    <textarea id="developingMsg" placeholder="Message shown when learner achieves Developing performance"></textarea>
                </div>
                <div class="form-group">
                    <label>Needs Improvement Message</label>
                    <textarea id="needsImpMsg" placeholder="Message shown when learner needs improvement"></textarea>
                </div>
            </div>
        </div>

        <!-- Step 3: Styling & Info -->
        <div class="panel">
            <h1>🎨 Step 3: Basic Information & Styling</h1>
            
            <h2>Basic Information</h2>
            <div class="form-group">
                <label>Activity Title</label>
                <input type="text" id="title" placeholder="e.g., Risk Management Scenarios">
            </div>
            
            <div class="form-group">
                <label>Case/Module Number</label>
                <input type="text" id="caseNumber" placeholder="e.g., Training Module RM-2025">
            </div>

            <div class="form-group">
                <label>Folder Tab Text</label>
                <input type="text" id="folderTab" placeholder="e.g., Risk Management Training">
            </div>

            <h2>Colors & Styling</h2>
            <div class="color-grid">
                <div class="form-group">
                    <label>Background Gradient Start</label>
                    <input type="color" id="bgGradStart" value="#1e3c72">
                </div>
                <div class="form-group">
                    <label>Background Gradient End</label>
                    <input type="color" id="bgGradEnd" value="#2a5298">
                </div>
                <div class="form-group">
                    <label>Folder Background</label>
                    <input type="color" id="folderBg" value="#2c3e50">
                </div>
                <div class="form-group">
                    <label>Progress Bar Color</label>
                    <input type="color" id="progressColor" value="#3498db">
                </div>
            </div>

            <h2>Summary Section (Optional)</h2>
            <div class="checkbox-group">
                <input type="checkbox" id="includeContact" onchange="toggleContactInfo()">
                <label for="includeContact">Include a contact/resource information section in the summary</label>
            </div>
            
            <div id="contactSection" style="display: none; margin-top: 15px;">
                <div class="form-group">
                    <label>Section Title</label>
                    <input type="text" id="contactTitle" placeholder="e.g., Contact Information, Resources, Need Help?">
                </div>
                <div class="form-group">
                    <label>Section Content (HTML allowed)</label>
                    <textarea id="contactInfo" placeholder="e.g., For questions, contact support@company.com"></textarea>
                </div>
            </div>
        </div>

        <!-- Step 4: Preview & Export -->
        <div class="panel">
            <h1>👀 Step 4: Preview & Export</h1>
            
            <button class="btn btn-success" onclick="generatePreview()">🔄 Refresh Preview</button>
            <button class="btn btn-secondary" onclick="downloadCode()">⬇️ Download HTML File</button>
            
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchTab('preview')">Preview</button>
                <button class="tab-btn" onclick="switchTab('code')">View Code</button>
            </div>

            <div id="previewTab" class="tab-content active">
                <iframe id="previewFrame" srcdoc="<body style='display:flex;align-items:center;justify-content:center;height:100vh;font-family:sans-serif;color:#999;'>Click 'Refresh Preview' to see your activity</body>"></iframe>
            </div>

            <div id="codeTab" class="tab-content">
                <div class="code-output">
                    <button class="copy-btn" onclick="copyCode()">Copy Code</button>
                    <pre id="generatedCode">Click "Refresh Preview" to generate code...</pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        let scenarios = [];
        let generatedCodeContent = '';

        function toggleContactInfo() {
            const checked = document.getElementById('includeContact').checked;
            document.getElementById('contactSection').style.display = checked ? 'block' : 'none';
        }

        function renderScenarios() {
            const list = document.getElementById('scenarioList');
            list.innerHTML = '';
            
            if (scenarios.length === 0) {
                list.innerHTML = '<p style="color: #7f8c8d; padding: 20px; text-align: center;">No scenarios yet. Click "Add New Scenario" to get started!</p>';
                updateThresholdDisplay();
                return;
            }
            
            scenarios.forEach((scenario, index) => {
                const card = document.createElement('div');
                card.className = 'scenario-card';
                card.innerHTML = `
                    <h3>Scenario ${index + 1}: ${scenario.id || 'Untitled'}</h3>
                    <div class="form-group">
                        <label>Scene ID</label>
                        <input type="text" value="${scenario.id}" onchange="updateScenario(${index}, 'id', this.value)" placeholder="e.g., start, scenario2">
                        <div class="hint">Unique identifier for linking between scenes</div>
                    </div>
                    <div class="form-group">
                        <label>Heading</label>
                        <input type="text" value="${scenario.heading}" onchange="updateScenario(${index}, 'heading', this.value)" placeholder="e.g., Scenario 1: The Challenge">
                    </div>
                    <div class="form-group">
                        <label>Content</label>
                        <textarea onchange="updateScenario(${index}, 'content', this.value)" placeholder="Describe the scenario situation...">${scenario.content}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Think Prompt (optional)</label>
                        <input type="text" value="${scenario.thinkPrompt || ''}" onchange="updateScenario(${index}, 'thinkPrompt', this.value)" placeholder="e.g., What should you do in this situation?">
                    </div>
                    
                    <h3>Choices</h3>
                    <div id="choices-${index}">
                        ${scenario.choices.map((choice, cIndex) => `
                            <div class="choice-card">
                                <div class="form-group">
                                    <label>Choice Text</label>
                                    <textarea onchange="updateChoice(${index}, ${cIndex}, 'text', this.value)" placeholder="Enter the choice text...">${choice.text}</textarea>
                                </div>
                                <div class="form-group">
                                    <label>Next Scene ID</label>
                                    <input type="text" value="${choice.nextScene}" onchange="updateChoice(${index}, ${cIndex}, 'nextScene', this.value)" placeholder="e.g., scenario2, summary">
                                    <div class="hint">Enter 'summary' for the final scenario</div>
                                </div>
                                <div class="form-group">
                                    <label>Points</label>
                                    <input type="number" value="${choice.points}" onchange="updateChoice(${index}, ${cIndex}, 'points', this.value)" min="0" max="3">
                                    <div class="hint">Typically: 3 = correct, 1 = partially correct, 0 = incorrect</div>
                                </div>
                                <div class="form-group">
                                    <label>Feedback Type</label>
                                    <div class="feedback-options">
                                        <label><input type="radio" name="feedback-${index}-${cIndex}" value="excellent" ${choice.feedback === 'excellent' ? 'checked' : ''} onchange="updateChoice(${index}, ${cIndex}, 'feedback', this.value)"> Excellent</label>
                                        <label><input type="radio" name="feedback-${index}-${cIndex}" value="acceptable" ${choice.feedback === 'acceptable' ? 'checked' : ''} onchange="updateChoice(${index}, ${cIndex}, 'feedback', this.value)"> Acceptable</label>
                                        <label><input type="radio" name="feedback-${index}-${cIndex}" value="incorrect" ${choice.feedback === 'incorrect' ? 'checked' : ''} onchange="updateChoice(${index}, ${cIndex}, 'feedback', this.value)"> Incorrect</label>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Feedback Text (HTML allowed)</label>
                                    <textarea onchange="updateChoice(${index}, ${cIndex}, 'feedbackText', this.value)" placeholder="e.g., <strong>Correct!</strong> Explanation here...">${choice.feedbackText}</textarea>
                                </div>
                                <button class="btn btn-danger" onclick="removeChoice(${index}, ${cIndex})">Remove Choice</button>
                            </div>
                        `).join('')}
                    </div>
                    <button class="btn btn-secondary" onclick="addChoice(${index})">+ Add Choice</button>
                    <button class="btn btn-danger" onclick="removeScenario(${index})">Delete Scenario</button>
                `;
                list.appendChild(card);
            });
            
            updateThresholdDisplay();
        }

        function updateThresholdDisplay() {
            const count = scenarios.length;
            const info = document.getElementById('thresholdInfo');
            const inputs = document.getElementById('thresholdInputs');
            
            info.innerHTML = `You currently have <strong>${count} scenario${count !== 1 ? 's' : ''}</strong>. ${count > 0 ? 'Set the thresholds below:' : 'Add scenarios above to configure thresholds.'}`;
            
            if (count > 0) {
                inputs.style.display = 'block';
                document.getElementById('total1').textContent = count;
                document.getElementById('total2').textContent = count;
                document.getElementById('total3').textContent = count;
                document.getElementById('excellentThreshold').max = count;
                document.getElementById('goodThreshold').max = count;
                document.getElementById('developingThreshold').max = count;
            } else {
                inputs.style.display = 'none';
            }
        }

        function updateScenario(index, field, value) {
            scenarios[index][field] = value;
        }

        function updateChoice(scenarioIndex, choiceIndex, field, value) {
            if (field === 'points') value = parseInt(value);
            scenarios[scenarioIndex].choices[choiceIndex][field] = value;
        }

        function addScenario() {
            const newId = scenarios.length === 0 ? 'start' : `scenario${scenarios.length + 1}`;
            scenarios.push({
                id: newId,
                heading: '',
                content: '',
                thinkPrompt: '',
                choices: [
                    {
                        text: '',
                        nextScene: 'summary',
                        points: 3,
                        feedback: 'excellent',
                        feedbackText: ''
                    }
                ]
            });
            renderScenarios();
        }

        function removeScenario(index) {
            if (confirm('Delete this scenario?')) {
                scenarios.splice(index, 1);
                renderScenarios();
            }
        }

        function addChoice(scenarioIndex) {
            scenarios[scenarioIndex].choices.push({
                text: '',
                nextScene: 'summary',
                points: 0,
                feedback: 'incorrect',
                feedbackText: ''
            });
            renderScenarios();
        }

        function removeChoice(scenarioIndex, choiceIndex) {
            if (scenarios[scenarioIndex].choices.length > 1) {
                scenarios[scenarioIndex].choices.splice(choiceIndex, 1);
                renderScenarios();
            } else {
                alert('Each scenario must have at least one choice.');
            }
        }

        function generatePreview() {
            const code = generateCode();
            if (code) {
                document.getElementById('previewFrame').srcdoc = code;
                document.getElementById('generatedCode').textContent = code;
            }
        }

        function generateCode() {
            if (scenarios.length === 0) {
                alert('Please add at least one scenario first!');
                return '';
            }

            const title = document.getElementById('title').value || 'Branching Scenario';
            const caseNumber = document.getElementById('caseNumber').value || '';
            const folderTab = document.getElementById('folderTab').value || 'Training';
            const bgGradStart = document.getElementById('bgGradStart').value;
            const bgGradEnd = document.getElementById('bgGradEnd').value;
            const folderBg = document.getElementById('folderBg').value;
            const progressColor = document.getElementById('progressColor').value;
            
            const excellentThreshold = parseInt(document.getElementById('excellentThreshold').value) || 0;
            const goodThreshold = parseInt(document.getElementById('goodThreshold').value) || 0;
            const developingThreshold = parseInt(document.getElementById('developingThreshold').value) || 0;
            
            const excellentMsg = document.getElementById('excellentMsg').value || 'Excellent performance!';
            const goodMsg = document.getElementById('goodMsg').value || 'Good performance!';
            const developingMsg = document.getElementById('developingMsg').value || 'Your skills are developing.';
            const needsImpMsg = document.getElementById('needsImpMsg').value || 'Additional practice recommended.';
            
            const includeContact = document.getElementById('includeContact').checked;
            const contactTitle = document.getElementById('contactTitle').value || 'Contact Information';
            const contactInfo = document.getElementById('contactInfo').value || '';

            // Build scenario data object - store JSON as string
            const scenesObj = {};
            scenarios.forEach(s => {
                scenesObj[s.id] = {
                    heading: s.heading,
                    content: s.content,
                    thinkPrompt: s.thinkPrompt,
                    isMainScenario: true,
                    choices: s.choices
                };
            });
            scenesObj['summary'] = { isSummary: true };

            const totalScenarios = scenarios.length;
            const scenarioDataJSON = JSON.stringify({
                title: title,
                caseNumber: caseNumber,
                totalScenarios: totalScenarios,
                scenes: scenesObj
            });

            // Generate the complete HTML file
            generatedCodeContent = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${title}</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Lato', sans-serif; background: linear-gradient(135deg, ${bgGradStart} 0%, ${bgGradEnd} 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .container { max-width: 900px; width: 100%; }
        .case-folder { background: ${folderBg}; border-radius: 8px; padding: 35px; box-shadow: 0 20px 60px rgba(0,0,0,0.4); position: relative; }
        .folder-tab { position: absolute; top: -25px; left: 50px; background: #34495e; padding: 10px 45px; border-radius: 6px 6px 0 0; font-weight: 700; font-size: 13px; color: #ecf0f1; letter-spacing: 1px; box-shadow: 0 -5px 15px rgba(0,0,0,0.2); text-transform: uppercase; }
        .progress-bar { background: rgba(255,255,255,0.1); height: 6px; border-radius: 3px; margin-bottom: 25px; overflow: hidden; }
        .progress-fill { background: linear-gradient(90deg, ${progressColor}, #2ecc71); height: 100%; transition: width 0.5s ease; border-radius: 3px; }
        .paper-sheet { background: #ffffff; padding: 40px; border-radius: 4px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); min-height: 500px; position: relative; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        h1 { color: #2c3e50; margin-bottom: 8px; font-size: 32px; font-weight: 900; letter-spacing: -0.5px; }
        h2 { color: #34495e; margin-bottom: 20px; font-size: 22px; font-weight: 700; }
        .case-number { color: #7f8c8d; font-size: 13px; margin-bottom: 25px; font-weight: 600; letter-spacing: 0.5px; }
        .scenario-meta { display: flex; gap: 20px; margin-bottom: 25px; flex-wrap: wrap; }
        .meta-tag { background: #ecf0f1; padding: 6px 14px; border-radius: 4px; font-size: 12px; font-weight: 700; color: #34495e; text-transform: uppercase; letter-spacing: 0.5px; }
        .content { color: #2c3e50; line-height: 1.9; margin-bottom: 30px; font-size: 16px; font-weight: 400; }
        .think-prompt { background: #e8f4f8; border-left: 4px solid #3498db; padding: 15px 20px; margin: 25px 0; font-style: italic; color: #2c3e50; font-size: 15px; }
        .choices { display: flex; flex-direction: column; gap: 15px; margin-top: 30px; }
        .choice-btn { background: #34495e; color: white; border: none; padding: 18px 25px; border-radius: 6px; font-family: 'Lato', sans-serif; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: left; position: relative; line-height: 1.5; }
        .choice-btn:hover { background: #2c3e50; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.2); }
        .choice-btn:active { transform: translateY(0); }
        .choice-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .feedback { margin-top: 25px; padding: 22px; border-radius: 6px; animation: fadeIn 0.5s ease; font-size: 15px; line-height: 1.8; font-weight: 400; }
        .feedback.excellent { background: #d4edda; border-left: 5px solid #28a745; color: #155724; }
        .feedback.acceptable { background: #fff3cd; border-left: 5px solid #ffc107; color: #856404; }
        .feedback.incorrect { background: #f8d7da; border-left: 5px solid #dc3545; color: #721c24; }
        .feedback-icon { font-size: 20px; margin-right: 10px; font-weight: 700; }
        .feedback strong { font-weight: 700; }
        .continue-btn { background: #3498db; color: white; border: none; padding: 14px 35px; border-radius: 6px; font-family: 'Lato', sans-serif; font-size: 16px; font-weight: 700; cursor: pointer; margin-top: 20px; transition: all 0.3s ease; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .continue-btn:hover { background: #2980b9; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.2); }
        .summary { background: #ecf0f1; padding: 25px; border-radius: 6px; margin-top: 20px; border-left: 5px solid #3498db; }
        .summary h3 { color: #2c3e50; margin-bottom: 15px; font-weight: 700; font-size: 18px; }
        .summary-item { margin-bottom: 12px; color: #34495e; line-height: 1.6; }
        .score-breakdown { display: flex; gap: 25px; margin: 20px 0; flex-wrap: wrap; }
        .score-card { flex: 1; min-width: 150px; background: white; padding: 20px; border-radius: 6px; text-align